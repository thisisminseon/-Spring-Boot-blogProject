<!DOCTYPE html>
<html lang="ko">
	<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>í•™ìƒ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'í•¨ì´ˆë¡¬ë‹ì›€';
		}
		
		body {
			background-color: #f5f5f5;
			padding: 20px;
		}
		
		.container {
			max-width: 1200px;
			margin: 0 auto;
			background-color: white;
			padding: 30px;
			border-radius: 10px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}
		
		h1 {
			text-align: center;
			margin-bottom: 30px;
		}
		
		/* í¼ ì˜ì—­ ìŠ¤íƒ€ì¼ */
		.form-section {
			background-color: #f9f9f9;
			padding: 20px;
			border-radius: 8px;
			margin-bottom: 30px;
		}
		
		.form-section h2 {
			color: #DB7A9D;
			margin-bottom: 15px;
			font-size: 20px;
		}
		
		.form-group {
			margin-bottom: 15px;
		}
		
		label {
			display: block;
			margin-bottom: 5px;
			color: #555;
			font-weight: bold;
		}
		
		input[type="text"], input[type="number"] {
			width: 100%;
			padding: 10px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 14px;
		}
		
		input[type="text"]:focus, input[type="number"]:focus {
			outline: none;
			border-color: #DB7A9D;
		}
		
		/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
		button {
			padding: 10px 20px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 14px;
			font-weight: bold;
			margin-right: 10px;
			transition: all 0.3s;
		}
		
		.btn-add {
			background-color:#DB7A9D;
			color: white;
		}
		
		.btn-add:hover {
			background-color:#DB7A9D;
		}
		
		.btn-search {
			background-color: #2196F3;
			color: white;
		}
		
		.btn-search:hover {
			background-color: #0b7dda;
		}
		
		.btn-update {
			background-color: #ff9800;
			color: white;
			padding: 5px 10px;
			font-size: 12px;
		}
		
		.btn-update:hover {
			background-color: #e68900;
		}
		
		.btn-delete {
			background-color: #f44336;
			color: white;
			padding: 5px 10px;
			font-size: 12px;
		}
		
		.btn-delete:hover {
			background-color: #da190b;
		}
		
		.btn-reset {
			background-color: #9E9E9E;
			color: white;
		}
		
		.btn-reset:hover {
			background-color: #757575;
		}
		
		/* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
		.table-section {
			margin-top: 30px;
		}
		
		.table-section h2 {
			color: #333;
			margin-bottom: 15px;
		}
		
		table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 10px;
		}
		
		th {
			background-color:#DB7A9D;
			color: white;
			padding: 12px;
			text-align: left;
			font-weight: bold;
		}
		
		td {
			padding: 10px;
			border-bottom: 1px solid #ddd;
		}
		
		tr:hover {
			background-color: #f5f5f5;
		}
		
		/* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
		.message {
			padding: 10px;
			margin-bottom: 15px;
			border-radius: 4px;
			display: none;
		}
		
		.message.success {
			background-color: #d4edda;
			color: #155724;
			border: 1px solid #c3e6cb;
		}
		
		.message.error {
			background-color: #f8d7da;
			color: #721c24;
			border: 1px solid #f5c6cb;
		}
		
		/* ë¹ˆ ë°ì´í„° ë©”ì‹œì§€ */
		.no-data {
			text-align: center;
			padding: 20px;
			color: #999;
			}
	</style>
	</head>
	
	<body>
		<div class="container">
			<h1>ğŸ“š í•™ìƒ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
	
			<div id="message" class="message"></div>
	
			<!-- í•™ìƒ ì¶”ê°€/ìˆ˜ì • í¼ -->
			<div class="form-section">
				<h2 id="formTitle">âœï¸ í•™ìƒ ì¶”ê°€</h2>
				<form id="studentForm">
					<input type="hidden" id="studentId">
	
					<div class="form-group">
						<label>ì´ë¦„</label> <input type="text" id="name" placeholder="ì˜ˆ: ê¹€ì² ìˆ˜" required>
					</div>
	
					<div class="form-group">
						<label>ë‚˜ì´</label> <input type="number" id="age" placeholder="ì˜ˆ: 20" min="1" max="100" required>
					</div>
	
					<div class="form-group">
						<label>ì „ê³µ</label> <input type="text" id="major" placeholder="ì˜ˆ: ì»´í“¨í„°ê³µí•™" required>
					</div>
	
					<div class="form-group">
						<label>ì²¨ë¶€íŒŒì¼</label> <input type="file" id="file">
						<div id="existingFile"></div>
					</div>
	
					<button type="submit" id="submitBtn" class="btn-add">ì¶”ê°€í•˜ê¸°</button>
					<button type="button" class="btn-reset" onclick="resetForm()">ì´ˆê¸°í™”</button>
				</form>
			</div>
	
			<!-- í•™ìƒ ê²€ìƒ‰ -->
			<div class="form-section">
				<h2>ğŸ” í•™ìƒ ê²€ìƒ‰ (ID)</h2>
				<div style="display: flex; gap: 10px;">
					<input type="number" id="searchId" placeholder="í•™ìƒ ID"
						style="flex: 1;">
					<button class="btn-search" onclick="searchStudent()" style="background: #DB7A9D;">ê²€ìƒ‰</button>
					<button class="btn-reset" onclick="loadAllStudents()">ì „ì²´</button>
				</div>
			</div>
	
			<!-- í•™ìƒ ëª©ë¡ í…Œì´ë¸” -->
		<div class="table-section">
			<h2>ğŸ‘¥ í•™ìƒ ëª©ë¡</h2>
			<table>
				<thead>
					<tr>
						<th>ID</th>
						<th>ì´ë¦„</th>
						<th>ë‚˜ì´</th>
						<th>ì „ê³µ</th>
						<th>ì²¨ë¶€íŒŒì¼</th>
						<th>ê´€ë¦¬</th>
					</tr>
				</thead>
				<tbody id="studentList">
					<tr>
						<td colspan="6" class="no-data">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
					</tr>
				</tbody>
			</table>
		</div>

		<script>
		    window.onload = () => {
		        loadAllStudents();
		    };
		
		    // í•™ìƒ ì¶”ê°€ / ìˆ˜ì •
		    document.getElementById('studentForm').addEventListener('submit', async (e) => {
		        e.preventDefault();
		
		        const id = document.getElementById('studentId').value;
		        const name = document.getElementById('name').value;
		        const age =  parseInt(document.getElementById('age').value);
		        const major =  document.getElementById('major').value;
		        const fileInput = document.getElementById('file');
		        const file = fileInput.files[0]; //ì²¨ë¶€íŒŒì¼ ì„ íƒ íŒŒì¼
		        
		        /* const student = {
		              
		        }; */
		        
		        const formData = new FormData(); 
		        formData.append('name', name);
		        formData.append('age', age);
		        formData.append('major', major);
		        
		        if(file) {
		           formData.append('file', file);
		        }
		        
		        if (id) {
		           //ìˆ˜ì •
		            //await updateStudent(id, student);
		           await updateStudentWithFile(id, formData);
		        } else {
		           //ì¶”ê°€
		            //await addStudent(student);
		           await addStudentWithFile(formData);
		        }
		    });
		
		 // í•™ìƒ ì¶”ê°€
		    async function addStudentWithFile(formData) {
		        try {
		            const response = await fetch('/student/api/file/insert', {
		                method: 'POST',
		                body: formData //Content-type ì€ formDataê°€ ìë™ ì„¤ì •ì„ í•œë‹¤
		            });
		            const data = await response.json();
		            showMessage('í•™ìƒ ì¶”ê°€ ì™„ë£Œ! ID: ' + data.id, 'success');
		            resetForm();
		            loadAllStudents();
		        } catch (error) {
		            showMessage('ì¶”ê°€ ì‹¤íŒ¨: ' + error, 'error');
		        }
		    }
		 
		 
		    // í•™ìƒ ì¶”ê°€
		    async function addStudent(student) {
		        try {
		            const response = await fetch('/student/api/file/nsert', {
		                method: 'POST',
		                headers: { 'Content-Type': 'application/json' },
		                body: JSON.stringify(student)
		            });
		
		            const data = await response.json();
		            showMessage('í•™ìƒ ì¶”ê°€ ì™„ë£Œ! ID: ' + data.id, 'success');
		            resetForm();
		            loadAllStudents();
		        } catch (error) {
		            showMessage('ì¶”ê°€ ì‹¤íŒ¨: ' + error, 'error');
		        }
		    }
		
		    // ì „ì²´ í•™ìƒ ì¡°íšŒ
		    async function loadAllStudents() {
		        try {
		            const response = await fetch('/student/api/list');
		            const data = await response.json();
		            displayStudents(data);
		        } catch (error) {
		            showMessage('ì¡°íšŒ ì‹¤íŒ¨: ' + error, 'error');
		        }
		    }
		
		    // íŠ¹ì • í•™ìƒ ì¡°íšŒ
		    async function searchStudent() {
		        const id = document.getElementById("searchId").value;
		        if (!id) {
		            alert("í•™ìƒ id ì…ë ¥");
		            return;
		        }
		
		        try {
		            const response = await fetch('/student/api/' + id);
		            if (!response.ok) {
		                throw new Error("í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”");
		            }
		            const data = await response.json();
		            displayStudents([data]);
		            showMessage(`ID ${id}ë²ˆ í•™ìƒì„ ì°¾ì•˜ìŠµë‹ˆë‹¤`, 'success');
		        } catch (error) {
		            showMessage(error.message, 'error');
		        }
		    }
		
		    // ìˆ˜ì • ë²„íŠ¼ í´ë¦­
		    function editStudent(id, name, age, major,fileName) {
		        document.getElementById('studentId').value = id;
		        document.getElementById('name').value = name;
		        document.getElementById('age').value = age;
		        document.getElementById('major').value = major;
		        
		        //ê¸°ì¡´ íŒŒì¼ëª… í‘œì‹œ
		        const existingFile = document.getElementById('existingFile');
		        
		        if(fileName) {
		        	existingFile.innerHTML =
		        	    '<span style="font-size:12px;color:#666;">ê¸°ì¡´ íŒŒì¼ : <strong>'
		        	    + fileName +
		        	    '</strong> (ìƒˆ íŒŒì¼ ì„ íƒ ì‹œ êµì²´ë¨)</span>';
		        }else{
		           existingFile.innerHTML='';
		        }
		
		        document.getElementById('formTitle').textContent = `âœï¸ í•™ìƒ ìˆ˜ì • (ID: ${id})`;
		        document.getElementById('submitBtn').textContent = 'ìˆ˜ì •í•˜ê¸°';
		        document.getElementById('submitBtn').className = 'btn-update';
		
		        window.scrollTo({ top: 0, behavior: 'smooth' });
		    }
		
		    // ì‹¤ì œ ìˆ˜ì • ì²˜ë¦¬
		    async function updateStudentWithFile(id, formData) {
		        try {
		            const response = await fetch('/student/api/file/' + id, {
		                method: 'PUT',
		                body: formData
		            });
		
		           if(!response.ok) {
		              throw new Error('ì„œë²„ ì˜¤ë¥˜');
		           }
		           
		            showMessage('í•™ìƒì •ë³´ ìˆ˜ì • ì™„ë£Œ', 'success');
		            resetForm();
		            loadAllStudents();
		        } catch (error) {
		            showMessage('ìˆ˜ì • ì‹¤íŒ¨: ' + error, 'error');
		        }
		    }
		    
		    async function updateStudent(id, student) {
		        try {
		            const response = await fetch('/student/api/' + id, {
		                method: 'PUT',
		                headers: { 'Content-Type': 'application/json' },
		                body: JSON.stringify(student)
		            });
		
		            await response.json();
		            showMessage('í•™ìƒì •ë³´ ìˆ˜ì • ì™„ë£Œ', 'success');
		            resetForm();
		            loadAllStudents();
		        } catch (error) {
		            showMessage('ìˆ˜ì • ì‹¤íŒ¨: ' + error, 'error');
		        }
		    }
		
		    // ì‚­ì œ
		    async function deleteStudent(id) {
		        if (!confirm('ì •ë§ ì‚­ì œ??')) return;
		
		        try {
		            await fetch('/student/api/file' + id, { 
		               method: 'DELETE' 
		            });
		            
		            if(!response.ok) {
		               throw new Error('ì„œë²„ ì˜¤ë¥˜');
		            }
		            
		            showMessage('ì‚­ì œ ì™„ë£Œ', 'success');
		            loadAllStudents();
		        } catch (error) {
		            showMessage('ì‚­ì œ ì‹¤íŒ¨: ' + error, 'error');
		        }
		    }
		
		    // í¼ ì´ˆê¸°í™”
		    function resetForm() {
		        document.getElementById('studentForm').reset();
		        document.getElementById('studentId').value = '';
		        document.getElementById('formTitle').textContent = 'âœ í•™ìƒ ì¶”ê°€';
		        document.getElementById('submitBtn').textContent = 'ì¶”ê°€í•˜ê¸°';
		        document.getElementById('submitBtn').className = 'btn-add';
		    }
		
		    
		 // ì´ë¯¸ì§€ íŒŒì¼ì¸ì§€ í™•ì¸
		    function isImageFile(fileName) {
		        if (!fileName) return false;
		        return /\.(jpg|jpeg|png|gif|webp)$/i.test(fileName);
		    }
		 
		    
		    // í•™ìƒ ëª©ë¡ ì¶œë ¥
		    function displayStudents(students) {
		        const tbody = document.getElementById('studentList');
		        tbody.innerHTML = '';
		
		        if (students.length === 0) {
		            tbody.innerHTML = '<tr><td colspan="5">ë“±ë¡ëœ í•™ìƒì´ ì—†ë‹¤</td></tr>';
		            return;
		        }
		
		        students.forEach(student => {
		           //íŒŒì¼ ì •ë³´ í‘œì‹œ
		           let fileCell = '';
		           if (student.fileName) {
		              const fileSize = formatBytes(student.fileSize);
		              
		              
		              let preview = '';
		               if (isImageFile(student.fileName)) {
		                   preview = `
		                       <img src="/student/file/image/${student.id}"
		                            style="width:80px; height:auto; display:block; margin-bottom:5px;">
		                   `;
		               }
		               
		              
		              fileCell = `
		                 ${preview}
		                       <div>
		                          ${student.fileName}
		                          <br>
		                          <span class="badge-file">${fileSize}</span>
		                          <button class="btn-download" onclick="downloadFile(${student.id})">ë‹¤ìš´ë¡œë“œ</button>
		                       </div>
		                       `;
		           } else {
		              fileCell = '<span class="badge-none">íŒŒì¼ ì—†ìŒ</span>';
		           }
		            tbody.innerHTML += `
		                <tr>
		                    <td>${student.id}</td>
		                    <td>${student.name}</td>
		                    <td>${student.age}</td>
		                    <td>${student.major}</td>
		                    <td>${fileCell}</td>
		                    <td>
		                        <button class="btn-update"
		                            onclick="editStudent(${student.id}, '${student.name}', ${student.age}, '${student.major}','${student.fileName}')">
		                            ìˆ˜ì •
		                        </button>
		                        <button class="btn-delete"
		                            onclick="deleteStudent(${student.id})">
		                            ì‚­ì œ
		                        </button>
		                    </td>
		                </tr>
		            `;
		        });
		    }
		
		    
		    //íŒŒì¼ í¬ê¸° í¬ë©§íŒ…
		    function formatBytes(bytes) {
		       if (!bytes) return '0B'; //0 ë˜ëŠ” null ì´ë©´
		       const k = 1024; //1kb = 1024B
		       const sizes = ['B','KB','MB','GB']; //ë‹¨ìœ„ë¥¼ ë°°ì—´ì— ì €ì¥
		       const i = Math.floor(Math.log(bytes) / Math.log(k)); //Math.floor ì†Œìˆ˜ì ì„ ë²„ë¦¼. ë‹¨ìœ„ ì´ˆê³¼ ë°©ì§€
		       return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' '+sizes[i];
		       //Math.pow(k, i) => bytes / (1024^i)
		       //toFixed(2) ì†Œìˆ˜ì  2ìë¦¬ë¡œ ìë¥´ê¸°
		       //parseFloat()  ìˆ«ìë¡œ ë‹¤ì‹œ ë³€í™˜
		       //sizes[i] ë‹¨ìœ„ ë¶™ì—¬ì„œ ë°˜í™˜
		       //0ì²˜ë¦¬->ë‹¨ìœ„ê²°ì •->í¬ê¸°í™˜ì‚°->ì†Œìˆ˜ì ì •ë¦¬->ë‹¨ìœ„ ë¶™ì—¬ì„œ ë°˜í™˜ ê³¼ì •ìœ¼ë¡œ ì²˜ë¦¬í•˜ë¼ ëŠ” ëœ»
		    }
		    
		    
		    // ë©”ì‹œì§€ í‘œì‹œ
		    function showMessage(message, type) {
		        const messageDiv = document.getElementById('message');
		        messageDiv.textContent = message;
		        messageDiv.className = 'message ' + type;
		        messageDiv.style.display = 'block';
		
		        setTimeout(() => {
		            messageDiv.style.display = 'none';
		        }, 3000);
		    }
		</script>
	</body>
</html>